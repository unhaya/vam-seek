/**
 * VAM Seek - 2D Video Seek Marker Library
 *
 * @version 1.3.5
 * @license MIT
 * @author VAM Project
 *
 * Usage:
 *   <script src="https://your-domain.com/vam-seek.js"><\/script>
 *   <script>
 *     VAMSeek.init({
 *       video: document.getElementById('myVideo'),
 *       container: document.getElementById('gridContainer'),
 *       columns: 5,
 *       secondsPerCell: 15,
 *       onError: (err) => console.error('VAMSeek error:', err)
 *     });
 *   </script>
 */
!function(t){"use strict";const e=new class{constructor(t=5,e=500){this.maxVideos=t,this.maxFramesPerVideo=e,this.videoOrder=[],this.caches=new Map,this.frameOrder=new Map}_getOrCreateCache(t){if(this.caches.has(t)){const e=this.videoOrder.indexOf(t);-1!==e&&(this.videoOrder.splice(e,1),this.videoOrder.push(t))}else{if(this.videoOrder.length>=this.maxVideos){const t=this.videoOrder.shift(),e=this.caches.get(t);if(e)for(const t of e.values())t&&t.blobUrl&&URL.revokeObjectURL(t.blobUrl);this.caches.delete(t),this.frameOrder.delete(t)}this.caches.set(t,new Map),this.frameOrder.set(t,[]),this.videoOrder.push(t)}return this.caches.get(t)}get(t,e){const s=this.caches.get(t);if(!s)return null;const i=e.toFixed(2);return s.get(i)||null}put(t,e,s){const i=this._getOrCreateCache(t),a=e.toFixed(2),r=this.frameOrder.get(t);if(i.has(a)){const t=i.get(a);t&&t.blobUrl&&URL.revokeObjectURL(t.blobUrl);const e=r.indexOf(a);-1!==e&&r.splice(e,1)}else for(;r.length>=this.maxFramesPerVideo;){const t=r.shift(),e=i.get(t);e&&e.blobUrl&&URL.revokeObjectURL(e.blobUrl),i.delete(t)}i.set(a,s),r.push(a)}hasVideo(t){return this.caches.has(t)}getVideoCache(t){return this.caches.get(t)}clear(){for(const t of this.caches.values())for(const e of t.values())e&&e.blobUrl&&URL.revokeObjectURL(e.blobUrl);this.caches.clear(),this.frameOrder.clear(),this.videoOrder=[]}get size(){let t=0;for(const e of this.caches.values())t+=e.size;return t}}(5);class s{constructor(t){this.video=t.video,this.container=t.container,this.columns=t.columns||3,this.secondsPerCell=t.secondsPerCell||15,this.thumbWidth=t.thumbWidth||160,this.thumbHeight=t.thumbHeight||90,this.markerSvg=t.markerSvg||null,this.onSeek=t.onSeek||null,this.onCellClick=t.onCellClick||null,this.onError=t.onError||null,this.autoScroll=!1!==t.autoScroll,this.scrollBehavior=t.scrollBehavior||"center",this.frameCache=e,this._captureCanvas=document.createElement("canvas"),this._captureCanvas.width=this.thumbWidth,this._captureCanvas.height=this.thumbHeight,this._captureCtx=this._captureCanvas.getContext("2d"),this.parallelExtractors=t.parallelExtractors||1,this.state={rows:0,totalCells:0,gridWidth:0,gridHeight:0,cellWidth:0,cellHeight:0,gridGap:2,markerX:0,markerY:0,targetX:0,targetY:0,currentCellX:0,currentCellY:0,isDragging:!1,isAnimating:!1,animationId:null,extractorVideos:[],currentTaskId:0,activeTaskId:null,currentVideoUrl:null,rebuildTimeoutId:null,lastScrollTime:0,scrollAnimationId:null,positionTimerId:null},this.grid=null,this.marker=null,this._init()}_init(){this._createGrid(),this._createMarker(),this._bindEvents(),this.video.duration&&this.rebuild()}_createGrid(){this.grid=document.createElement("div"),this.grid.className="vam-thumbnail-grid",this.grid.style.cssText="\n                display: grid;\n                gap: 2px;\n                position: relative;\n                user-select: none;\n                -webkit-user-select: none;\n            ",this.container.appendChild(this.grid)}_createMarker(){this.marker=document.createElement("div"),this.marker.className="vam-marker",this.marker.style.cssText="\n                position: absolute;\n                top: 0;\n                left: 0;\n                pointer-events: none;\n                z-index: 100;\n                transform: translate(-50%, -50%);\n                transition: none;\n            ",this.markerSvg?this.marker.innerHTML=this.markerSvg:this.marker.innerHTML='\n                    <svg width="40" height="40" viewBox="0 0 155.91 155.91">\n                        <defs>\n                            <style>\n                                .vam-marker-circle { fill: #b7392b; stroke: #fff; stroke-miterlimit: 10; stroke-width: 8px; }\n                                .vam-marker-play { fill: #fff; }\n                            </style>\n                        </defs>\n                        <circle class="vam-marker-circle" cx="77.95" cy="77.95" r="63.49"/>\n                        <path class="vam-marker-play" d="M66.6,109.32c-5.24,3.39-9.52,1.05-9.52-5.18v-52.38c0-6.24,4.28-8.57,9.52-5.18l38.99,25.21c5.24,3.39,5.24,8.93,0,12.31l-38.99,25.21Z"/>\n                    </svg>\n                ',this.marker.style.display="none",this.grid.style.position="relative",this.grid.appendChild(this.marker)}_bindEvents(){this._boundHandlers={onTimeUpdate:()=>this._onTimeUpdateForScroll(),onLoadedMetadata:()=>this.rebuild(),onMouseDown:t=>this._onMouseDown(t),onMouseMove:t=>this._onMouseMove(t),onMouseUp:()=>this._onMouseUp(),onTouchStart:t=>{t.preventDefault(),this.state.isDragging=!0,this._handleMousePosition(t.touches[0])},onTouchMove:t=>{this.state.isDragging&&(t.preventDefault(),this._handleMousePosition(t.touches[0]))},onTouchEnd:()=>{this.state.isDragging&&(this.state.isDragging=!1,this._scrollToMarker())},onKeyDown:t=>this._onKeyDown(t)},this.video.addEventListener("timeupdate",this._boundHandlers.onTimeUpdate),this.video.addEventListener("loadedmetadata",this._boundHandlers.onLoadedMetadata),this._startPositionTimer(),this.grid.addEventListener("mousedown",this._boundHandlers.onMouseDown),document.addEventListener("mousemove",this._boundHandlers.onMouseMove),document.addEventListener("mouseup",this._boundHandlers.onMouseUp),this.grid.addEventListener("touchstart",this._boundHandlers.onTouchStart,{passive:!1}),this.grid.addEventListener("touchmove",this._boundHandlers.onTouchMove,{passive:!1}),this.grid.addEventListener("touchend",this._boundHandlers.onTouchEnd),document.addEventListener("keydown",this._boundHandlers.onKeyDown),this.resizeObserver=new ResizeObserver(()=>{this.grid&&this.state.totalCells>0&&this._updateGridDimensions()}),this.resizeObserver.observe(this.container)}rebuild(){this.video.duration&&(this.state.scrollAnimationId&&(cancelAnimationFrame(this.state.scrollAnimationId),this.state.scrollAnimationId=null),this.state.animationId&&(cancelAnimationFrame(this.state.animationId),this.state.animationId=null,this.state.isAnimating=!1),this.state.activeTaskId=null,this._cleanupExtractorVideos(),this.state.currentVideoUrl=this.video.src,this.frameCache.hasVideo(this.state.currentVideoUrl)||this.frameCache._getOrCreateCache(this.state.currentVideoUrl),this._calculateGridSize(),this._renderGrid(),this.container.scrollTop=0,this.state.rebuildTimeoutId&&cancelAnimationFrame(this.state.rebuildTimeoutId),this.state.rebuildTimeoutId=requestAnimationFrame(()=>{this.state.rebuildTimeoutId=null,this._updateGridDimensions(),this._initMarker(),this.container.scrollTop=0,this._extractAllFrames()}))}configure(t){void 0!==t.columns&&(this.columns=t.columns),void 0!==t.secondsPerCell&&(this.secondsPerCell=t.secondsPerCell),void 0!==t.thumbWidth&&(this.thumbWidth=t.thumbWidth),void 0!==t.thumbHeight&&(this.thumbHeight=t.thumbHeight),this.rebuild()}seekTo(t){this.video.currentTime=Math.max(0,Math.min(t,this.video.duration))}moveToCell(t,e){if(t>=this.columns)e+=Math.floor(t/this.columns),t%=this.columns;else if(t<0){for(;t<0&&e>0;)e--,t+=this.columns;t=Math.max(0,t)}t=Math.max(0,t);const s=(e=Math.max(0,e))*this.columns+t,i=this.state.totalCells-1;s>i&&(e=Math.floor(i/this.columns),t=i%this.columns),this.state.currentCellX=t,this.state.currentCellY=e;const a=this.state.gridGap||2,r=t*this.state.cellWidth+t*a+this.state.cellWidth/2,n=e*this.state.cellHeight+e*a+this.state.cellHeight/2;this._moveMarkerTo(r,n,!0);const o=(e*this.columns+t+.5)*this.secondsPerCell;this.seekTo(Math.min(o,this.video.duration)),this._scrollToMarker()}setScrollMode(t){this.state.scrollAnimationId&&(cancelAnimationFrame(this.state.scrollAnimationId),this.state.scrollAnimationId=null),this.state.lastScrollTime=Date.now(),"off"===t?this.autoScroll=!1:(this.scrollBehavior=t,this.autoScroll=!0)}destroy(){this.state.activeTaskId=null,this.state.animationId&&cancelAnimationFrame(this.state.animationId),this.state.scrollAnimationId&&cancelAnimationFrame(this.state.scrollAnimationId),this._stopPositionTimer(),this._cleanupExtractorVideos(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this._boundHandlers&&(this.video.removeEventListener("timeupdate",this._boundHandlers.onTimeUpdate),this.video.removeEventListener("loadedmetadata",this._boundHandlers.onLoadedMetadata),document.removeEventListener("mousemove",this._boundHandlers.onMouseMove),document.removeEventListener("mouseup",this._boundHandlers.onMouseUp),document.removeEventListener("keydown",this._boundHandlers.onKeyDown),this._boundHandlers=null),this.grid.remove(),this.marker.remove()}_cleanupExtractorVideos(){for(const t of this.state.extractorVideos)t&&(t.pause(),t.src="",t.remove());this.state.extractorVideos=[]}getCurrentCell(){const t=this.video.currentTime,e=Math.floor(t/this.secondsPerCell);return{index:e,col:e%this.columns,row:Math.floor(e/this.columns),time:t,cellStartTime:e*this.secondsPerCell,cellEndTime:(e+1)*this.secondsPerCell}}_calculateGridSize(){const t=this.video.duration;this.state.totalCells=Math.ceil(t/this.secondsPerCell),this.state.rows=Math.ceil(this.state.totalCells/this.columns)}_renderGrid(){this.grid.innerHTML="",this.grid.style.gridTemplateColumns=`repeat(${this.columns}, 1fr)`;for(let t=0;t<this.state.totalCells;t++){const e=document.createElement("div");e.className="vam-cell",e.dataset.index=t,e.style.cssText="\n                    aspect-ratio: 16/9;\n                    background: #1a1a2e;\n                    position: relative;\n                    overflow: hidden;\n                    cursor: pointer;\n                ";const s=document.createElement("div");s.className="vam-loader",s.style.cssText="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    width: 20px;\n                    height: 20px;\n                    border: 2px solid rgba(255,255,255,0.3);\n                    border-top-color: #fff;\n                    border-radius: 50%;\n                    animation: vam-spin 1s linear infinite;\n                ",e.appendChild(s);const i=t*this.secondsPerCell,a=document.createElement("span");a.className="vam-time",a.textContent=this._formatTime(i),a.style.cssText="\n                    position: absolute;\n                    bottom: 2px;\n                    right: 2px;\n                    background: rgba(0,0,0,0.7);\n                    color: #fff;\n                    padding: 1px 4px;\n                    font-size: 9px;\n                    border-radius: 2px;\n                    pointer-events: none;\n                ",e.appendChild(a),this.grid.appendChild(e)}if(!document.getElementById("vam-styles")){const t=document.createElement("style");t.id="vam-styles",t.textContent="\n                    @keyframes vam-spin {\n                        to { transform: translate(-50%, -50%) rotate(360deg); }\n                    }\n                ",document.head.appendChild(t)}this.grid.appendChild(this.marker)}_updateGridDimensions(){const t=this.grid.getBoundingClientRect();this.state.gridWidth=t.width,this.state.gridHeight=t.height;const e=this.grid.querySelector(".vam-cell");if(e){const t=e.getBoundingClientRect();this.state.cellWidth=t.width,this.state.cellHeight=t.height;const s=getComputedStyle(this.grid);this.state.gridGap=parseFloat(s.gap)||2}else this.state.cellWidth=t.width/this.columns,this.state.cellHeight=t.height/this.state.rows,this.state.gridGap=2}async _extractAllFrames(){if(!this.state.currentVideoUrl)return;const t=++this.state.currentTaskId;this.state.activeTaskId=t;const e=this.state.currentVideoUrl,s=()=>this.state.activeTaskId===t&&this.state.currentVideoUrl===e;try{const t=[...this.state.extractorVideos];if(this.state.extractorVideos=[],!s())return;const i=[];for(let t=0;t<this.parallelExtractors;t++)i.push(this._createExtractorVideo(e));const a=await Promise.all(i);if(t.length>0&&setTimeout(()=>{for(const e of t)e&&(e.pause(),e.src="",e.remove())},0),!s()){for(const t of a)t&&(t.pause(),t.src="",t.remove());return}if(this.state.extractorVideos=a.filter(t=>null!=t),0===this.state.extractorVideos.length)return;const r=this.grid.querySelectorAll(".vam-cell"),n=this._getVisibleCellIndices(),o=Array.from({length:this.state.totalCells},(t,e)=>e).filter(t=>!n.includes(t));n.length>0&&s()&&await this._extractCellsByIndices(this.state.extractorVideos,n,r,e,s),o.length>0&&s()&&await this._extractCellsByIndices(this.state.extractorVideos,o,r,e,s)}catch(t){this.onError&&this.onError({type:"extraction",error:t,message:"Frame extraction failed"})}}_getVisibleCellIndices(){const t=this.container.getBoundingClientRect(),e=this.container.scrollTop,s=e,i=e+t.height,a=this.state.cellHeight+(this.state.gridGap||2),r=Math.floor(s/a),n=Math.ceil(i/a),o=[];for(let t=r;t<=n&&t<this.state.rows;t++)for(let e=0;e<this.columns;e++){const s=t*this.columns+e;s<this.state.totalCells&&o.push(s)}return o}async _extractCellsByIndices(t,e,s,i,a){const r=t.length,n=Math.ceil(e.length/r),o=t.map((t,r)=>{const o=r*n,h=Math.min(o+n,e.length),l=e.slice(o,h);return this._extractFramesByIndices(t,l,s,i,a)});await Promise.all(o)}async _extractFramesByIndices(t,e,s,i,a){for(const r of e){if(!a())break;const e=(r+.5)*this.secondsPerCell,n=s[r];if(!n)continue;const o=this.frameCache.get(i,e);if(o){this._displayFrame(n,o);continue}if(!t||!a())break;const h=await this._extractFrame(t,e);if(!a())break;h&&(this.frameCache.put(i,e,h),this._displayFrame(n,h))}}_createExtractorVideo(t){return new Promise((e,s)=>{const i=document.createElement("video");i.style.display="none",i.muted=!0,i.playsInline=!0,i.preload="auto",t.startsWith("http")&&!t.startsWith(location.origin)&&(i.crossOrigin="anonymous"),i.src=t;const a=()=>{i.removeEventListener("loadeddata",a),i.removeEventListener("canplay",a),e(i)};i.addEventListener("loadeddata",a),i.addEventListener("canplay",a),i.addEventListener("error",s),setTimeout(()=>{i.removeEventListener("loadeddata",a),i.removeEventListener("canplay",a),i.readyState>=2?e(i):s(new Error("Video load timeout"))},1e4),document.body.appendChild(i),i.load()})}async _extractFrame(t,e){return Math.abs(t.currentTime-e)<.1&&t.readyState>=2?await this._captureFrame(t):new Promise(s=>{let i=!1;const a=async()=>{if(i)return;i=!0,t.removeEventListener("seeked",a);const e=await this._captureFrame(t);s(e)};t.addEventListener("seeked",a),t.currentTime=Math.min(e,t.duration-.1),setTimeout(async()=>{if(i)return;i=!0,t.removeEventListener("seeked",a);const e=await this._captureFrame(t);s(e)},5e3)})}_captureFrame(t){return t.readyState<2?Promise.resolve(null):new Promise(e=>{try{this._captureCtx.drawImage(t,0,0,this.thumbWidth,this.thumbHeight),this._captureCanvas.toBlob(t=>{if(t){const s=URL.createObjectURL(t);e({blobUrl:s,width:this.thumbWidth,height:this.thumbHeight})}else e(null)},"image/jpeg",.8)}catch(t){e(null)}})}_displayFrame(t,e){const s=t.querySelector(".vam-loader");s&&s.remove();const i=t.querySelector("img");i&&i.remove();const a=new Image;a.onload=()=>{a.style.cssText="\n                    width: 100%;\n                    height: 100%;\n                    object-fit: cover;\n                    pointer-events: none;\n                    opacity: 0;\n                    transition: opacity 0.4s ease-in-out;\n                ",t.insertBefore(a,t.firstChild),requestAnimationFrame(()=>{a.style.opacity="1"})},a.src=e.blobUrl||e.dataUrl}_initMarker(){this.marker.style.display="block",this.state.markerX=0,this.state.markerY=this.state.cellHeight/2,this.state.targetX=this.state.markerX,this.state.targetY=this.state.markerY,this.state.currentCellX=0,this.state.currentCellY=0,this._updateMarkerPosition()}_moveMarkerTo(t,e,s=!0){this.state.targetX=Math.max(0,Math.min(t,this.state.gridWidth)),this.state.targetY=Math.max(0,Math.min(e,this.state.gridHeight)),s&&!this.state.isAnimating?(this.state.isAnimating=!0,this._animateMarker()):s||(this.state.markerX=this.state.targetX,this.state.markerY=this.state.targetY,this._updateMarkerPosition())}_animateMarker(){const t=this.state.targetX-this.state.markerX,e=this.state.targetY-this.state.markerY;if(Math.abs(t)<.5&&Math.abs(e)<.5)return this.state.markerX=this.state.targetX,this.state.markerY=this.state.targetY,this.state.isAnimating=!1,void this._updateMarkerPosition();this.state.markerX+=.15*t,this.state.markerY+=.15*e,this._updateMarkerPosition(),this.state.animationId=requestAnimationFrame(()=>this._animateMarker())}_updateMarkerPosition(){this.marker.style.transform=`translate(${this.state.markerX}px, ${this.state.markerY}px) translate(-50%, -50%)`}_scrollToMarker(){if(!this.autoScroll)return;const t=this.container.clientHeight,e=this.state.markerY;if("edge"===this.scrollBehavior){const s=this.container.scrollTop;e<s+50?this._smoothScrollTo(Math.max(0,e-100)):e>s+t-50&&this._smoothScrollTo(e-t+100)}else{const s=Math.max(0,e-t/2);this._smoothScrollTo(s)}}_smoothScrollTo(t){const e=this.container.scrollTop,s=t-e;if(Math.abs(s)<1)return;this.state.scrollAnimationId&&cancelAnimationFrame(this.state.scrollAnimationId);let i=null;const a=this.container,r=this.state;this.state.scrollAnimationId=requestAnimationFrame(function t(n){i||(i=n);const o=n-i,h=Math.min(o/400,1),l=1-Math.pow(1-h,3);a.scrollTop=e+s*l,r.scrollAnimationId=h<1?requestAnimationFrame(t):null})}_calculatePositionFromTime(t){if(0===this.state.totalCells||this.secondsPerCell<=0)return{x:0,y:this.state.cellHeight/2};const e=this.state.gridGap||2,s=Math.min(t/this.secondsPerCell,this.state.totalCells-.001),i=Math.floor(s/this.columns),a=s-i*this.columns,r=Math.floor(a),n=a-r,o=r*(this.state.cellWidth+e)+n*this.state.cellWidth,h=i*(this.state.cellHeight+e)+this.state.cellHeight/2;return{x:Math.max(0,Math.min(o,this.state.gridWidth)),y:Math.max(this.state.cellHeight/2,h)}}_calculateTimeFromPosition(t,e){const s=this.state.gridGap||2,i=this.state.cellHeight+s,a=(e-this.state.cellHeight/2)/i,r=Math.max(0,Math.min(Math.floor(a+.5),this.state.rows-1)),n=this.state.cellWidth+s,o=t/n,h=Math.max(0,Math.min(Math.floor(o),this.columns-1)),l=t-h*n,c=Math.max(0,Math.min(l/this.state.cellWidth,1)),d=(r*this.columns+h+c)*this.secondsPerCell;return Math.max(0,Math.min(d,this.video.duration))}_startPositionTimer(){this._stopPositionTimer(),this.state.positionTimerId=setInterval(()=>{if(!this.video.paused&&!this.state.isDragging&&this.state.totalCells>0){const t=this._calculatePositionFromTime(this.video.currentTime);this._moveMarkerTo(t.x,t.y,!0);const e=this.state.gridGap||2,s=this.state.cellWidth+e,i=this.state.cellHeight+e;this.state.currentCellX=Math.max(0,Math.min(Math.floor(t.x/s),this.columns-1)),this.state.currentCellY=Math.max(0,Math.min(Math.floor(t.y/i),this.state.rows-1))}},16)}_stopPositionTimer(){this.state.positionTimerId&&(clearInterval(this.state.positionTimerId),this.state.positionTimerId=null)}_onTimeUpdateForScroll(){if(!this.state.isDragging&&this.autoScroll&&!this.video.paused){const t=Date.now();t-this.state.lastScrollTime>500&&(this._scrollToMarker(),this.state.lastScrollTime=t)}}_onMouseDown(t){t.preventDefault(),this.state.isDragging=!0,this._handleMousePosition(t)}_onMouseMove(t){this.state.isDragging&&this._handleMousePosition(t)}_onMouseUp(){if(this.state.isDragging){this.state.isDragging=!1;const t=this.state.gridGap||2,e=this.state.cellWidth+t,s=this.state.cellHeight+t,i=this.state.markerX-this.state.cellWidth/2,a=this.state.markerY-this.state.cellHeight/2,r=Math.max(0,Math.min(Math.round(i/e),this.columns-1)),n=Math.max(0,Math.min(Math.round(a/s),this.state.rows-1)),o=n*s+this.state.cellHeight/2;this._moveMarkerTo(this.state.markerX,o,!0),this.state.currentCellX=r,this.state.currentCellY=n,this._scrollToMarker()}}_handleMousePosition(t){const e=this.grid.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,a=Math.max(0,Math.min(s,this.state.gridWidth)),r=Math.max(0,Math.min(i,this.state.gridHeight));this._moveMarkerTo(a,r,!1);const n=this._calculateTimeFromPosition(a,r);this.seekTo(n),this.onSeek&&this.onSeek(n,this.getCurrentCell())}_onKeyDown(t){if(!this.video.duration)return;let e=this.state.currentCellX,s=this.state.currentCellY;switch(t.key){case"ArrowLeft":e--;break;case"ArrowRight":e++;break;case"ArrowUp":s--;break;case"ArrowDown":s++;break;case"Home":e=0,s=0;break;case"End":const i=this.state.totalCells-1;e=i%this.columns,s=Math.floor(i/this.columns);break;case" ":return t.preventDefault(),void(this.video.paused?this.video.play():this.video.pause());default:return}t.preventDefault(),this.moveToCell(e,s)}_formatTime(t){return`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`}}const i=new Map;t.VAMSeek={init:function(t){if(!t.video||!t.container)throw new Error("VAMSeek: video and container are required");const e=new s(t);return i.set(t.video,e),e},getInstance:function(t){return i.get(t)},destroy:function(t){const e=i.get(t);e&&(e.destroy(),i.delete(t))},version:"1.3.5"}}("undefined"!=typeof window?window:this);